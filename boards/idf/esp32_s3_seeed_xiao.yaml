esp32:
  board: seeed_xiao_esp32s3
  variant: ESP32S3
  flash_size: 16MB
  platformio_options:
    board_build.flash_size: 16MB
  framework:
    type: esp-idf
    sdkconfig_options:
      # --- PSRAM (8MB) ---
      CONFIG_SPIRAM: y
      CONFIG_SPIRAM_SUPPORT: y
      CONFIG_SPIRAM_BOOT_INIT: y
      CONFIG_SPIRAM_USE_MALLOC: y
      # --- IMPORTANT: R8 PSRAM is OCTAL / OPI, not QUAD ---
      CONFIG_SPIRAM_MODE_OCT: y
      CONFIG_SPIRAM_SPEED_80M: y
      # (optional safety) explicitly disable quad
      CONFIG_SPIRAM_MODE_QUAD: n

      # USB Serial/JTAG console
      CONFIG_ESP_CONSOLE_USB_SERIAL_JTAG: y
      CONFIG_ESP_CONSOLE_UART: n

      # Keep internal RAM available for Wi-Fi / critical allocations
      CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL: "16384"
      CONFIG_SPIRAM_MALLOC_RESERVE_INTERNAL: "32768"

      # --- Wi-Fi stability under typical ESPHome load ---
      CONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM: "64"
      CONFIG_ESP_WIFI_DYNAMIC_TX_BUFFER_NUM: "64"
      CONFIG_ESP_WIFI_AMPDU_TX_ENABLED: y
      CONFIG_ESP_WIFI_AMPDU_RX_ENABLED: y

      # --- Watchdog (helps avoid false WDT resets on busy nodes) ---
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "30"

logger:
  hardware_uart: USB_SERIAL_JTAG

preferences:
  flash_write_interval: 1min
